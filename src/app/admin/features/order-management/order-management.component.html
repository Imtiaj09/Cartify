<div class="container-fluid">
  <!-- Top Action Bar -->
  <div class="d-flex justify-content-end flex-wrap mb-4">
    <button class="btn btn-success me-2" type="button" (click)="openAddOrderModal()">
      <i class="bi bi-plus-circle me-1"></i> Add Order
    </button>
    <button class="btn btn-outline-secondary">
      <i class="bi bi-three-dots-vertical"></i> More Action
    </button>
  </div>

  <!-- Summary Cards -->
  <div class="row g-4 mb-4">
    <div class="col-lg-3 col-md-6">
      <div class="card summary-card bg-primary-soft">
        <div class="card-body d-flex align-items-center">
          <div class="icon-circle bg-primary text-white">
            <i class="bi bi-cart-check"></i>
          </div>
          <div class="ms-3">
            <h5 class="card-title">Total Order</h5>
            <p class="card-text fw-bold fs-4">{{ totalOrderCount }}</p>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="card summary-card bg-warning-soft">
        <div class="card-body d-flex align-items-center">
          <div class="icon-circle bg-warning text-white">
            <i class="bi bi-clock-history"></i>
          </div>
          <div class="ms-3">
            <h5 class="card-title">New Order</h5>
            <p class="card-text fw-bold fs-4">{{ newOrderCount }}</p>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="card summary-card bg-success-soft">
        <div class="card-body d-flex align-items-center">
          <div class="icon-circle bg-success text-white">
            <i class="bi bi-check-circle"></i>
          </div>
          <div class="ms-3">
            <h5 class="card-title">Complete Order</h5>
            <p class="card-text fw-bold fs-4">{{ completeOrderCount }}</p>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <div class="card summary-card bg-danger-soft">
        <div class="card-body d-flex align-items-center">
          <div class="icon-circle bg-danger text-white">
            <i class="bi bi-x-circle"></i>
          </div>
          <div class="ms-3">
            <h5 class="card-title">Canceled Order</h5>
            <p class="card-text fw-bold fs-4">{{ canceledOrderCount }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Table Controls & Filters -->
  <div class="card border-light-subtle shadow-sm">
    <div class="card-body">
      <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
        <div class="btn-group" role="group">
          <button type="button"
            class="btn btn-outline-secondary"
            [class.active]="activeFilter === 'All'"
            (click)="setFilter('All')">
            All Order ({{ getOrderCount('All') }})
          </button>
          <button type="button"
            class="btn btn-outline-secondary"
            [class.active]="activeFilter === 'Delivered'"
            (click)="setFilter('Delivered')">
            Completed ({{ getOrderCount('Delivered') }})
          </button>
          <button type="button"
            class="btn btn-outline-secondary"
            [class.active]="activeFilter === 'Pending'"
            (click)="setFilter('Pending')">
            Pending ({{ getOrderCount('Pending') }})
          </button>
          <button type="button"
            class="btn btn-outline-secondary"
            [class.active]="activeFilter === 'Cancelled'"
            (click)="setFilter('Cancelled')">
            Canceled ({{ getOrderCount('Cancelled') }})
          </button>
        </div>
        <div class="d-flex flex-wrap align-items-center gap-2 mt-2 mt-md-0">
          <div class="input-group">
            <span class="input-group-text bg-transparent"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control border-start-0" placeholder="Search Order report...">
          </div>
          <button type="button"
            class="btn btn-outline-secondary square-btn"
            [disabled]="selectedOrderIds.size !== 1"
            (click)="editSelectedOrder()">
            <i class="bi bi-pencil"></i>
          </button>
          <button type="button"
            class="btn btn-outline-secondary square-btn"
            [disabled]="selectedOrderIds.size === 0"
            (click)="deleteSelectedOrders()">
            <i class="bi bi-trash"></i>
          </button>
          <button type="button"
            class="btn btn-outline-secondary square-btn"
            [disabled]="selectedOrderIds.size !== 1"
            (click)="viewReport()"
            aria-label="View cash memo report">
            <i class="bi bi-file-text"></i>
          </button>
          <button type="button"
            class="btn btn-outline-secondary square-btn"
            [disabled]="selectedOrderIds.size !== 1 || isReportDownloading"
            (click)="downloadOrder()"
            [attr.aria-label]="isReportDownloading ? 'Generating PDF' : 'Download cash memo PDF'">
            <span *ngIf="isReportDownloading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            <i *ngIf="!isReportDownloading" class="bi bi-download"></i>
          </button>
          <button type="button"
            class="btn btn-outline-secondary square-btn"
            [disabled]="selectedOrderIds.size !== 1"
            (click)="printOrder()"
            aria-label="Print cash memo">
            <i class="bi bi-printer"></i>
          </button>
        </div>
      </div>

      <!-- Order Table -->
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th scope="col" class="text-center" style="width: 44px;">
                <input type="checkbox"
                  class="form-check-input"
                  [checked]="areAllVisibleOrdersSelected()"
                  [indeterminate]="hasPartialSelection()"
                  (change)="toggleAllSelection()"
                  aria-label="Select all orders">
              </th>
              <th scope="col">NO.</th>
              <th scope="col">Order Id</th>
              <th scope="col">Product</th>
              <th scope="col">Date</th>
              <th scope="col">Price</th>
              <th scope="col">Payment</th>
              <th scope="col">Status</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let order of getPaginatedOrders(); let i = index">
              <td class="text-center">
                <input type="checkbox"
                  class="form-check-input"
                  [checked]="isSelected(order.id)"
                  (change)="toggleSelection(order.id)"
                  [attr.aria-label]="'Select order #' + order.id">
              </td>
              <td>{{ (currentPage - 1) * itemsPerPage + i + 1 }}</td>
              <td class="fw-bold">#{{ order.id }}</td>
              <td>
                <div class="d-flex align-items-center">
                  <img [src]="order.productImage" class="product-img me-2" alt="Product">
                  <span>{{ order.productName }}</span>
                </div>
              </td>
              <td>{{ order.date }}</td>
              <td>${{ order.price.toFixed(2) }}</td>
              <td>
                <div class="d-flex align-items-center">
                  <i class="bi bi-credit-card-2-front me-2 fs-5"></i>
                  <span>{{ order.paymentMethod }}</span>
                </div>
              </td>
              <td>
                <div class="dropdown status-dropdown" [class.show]="isStatusMenuOpen(order.id)">
                  <button class="btn btn-sm dropdown-toggle status-btn" type="button"
                    (click)="toggleStatusMenu(order.id, $event)"
                    [attr.aria-expanded]="isStatusMenuOpen(order.id)"
                    [ngClass]="{
                      'btn-outline-success': order.status === 'Delivered',
                      'btn-outline-warning': order.status === 'Pending',
                      'btn-outline-info': order.status === 'Shipped',
                      'btn-outline-danger': order.status === 'Cancelled'
                    }">
                    {{ order.status }}
                  </button>
                  <ul class="dropdown-menu" [class.show]="isStatusMenuOpen(order.id)" (click)="$event.stopPropagation()">
                    <li>
                      <button type="button" class="dropdown-item text-success" (click)="updateStatus(order, 'Delivered')">
                        <i class="bi bi-check-circle me-2"></i>Delivered
                      </button>
                    </li>
                    <li>
                      <button type="button" class="dropdown-item text-warning" (click)="updateStatus(order, 'Pending')">
                        <i class="bi bi-clock me-2"></i>Pending
                      </button>
                    </li>
                    <li>
                      <button type="button" class="dropdown-item text-info" (click)="updateStatus(order, 'Shipped')">
                        <i class="bi bi-truck me-2"></i>Shipped
                      </button>
                    </li>
                    <li>
                      <button type="button" class="dropdown-item text-danger" (click)="updateStatus(order, 'Cancelled')">
                        <i class="bi bi-x-circle me-2"></i>Cancelled
                      </button>
                    </li>
                  </ul>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination Controls -->
      <div class="d-flex justify-content-center mt-4">
        <nav aria-label="Order pagination">
          <ul class="pagination">
            <li class="page-item" [class.disabled]="currentPage === 1">
              <button class="page-link" (click)="prevPage()" aria-label="Previous">
                <span aria-hidden="true">&laquo; Previous</span>
              </button>
            </li>

            <li class="page-item" *ngFor="let page of paginationPages"
                [class.active]="page === currentPage"
                [class.disabled]="page === '...'">
              <button class="page-link"
                      (click)="page !== '...' && goToPage(page)">
                {{ page }}
              </button>
            </li>

            <li class="page-item" [class.disabled]="currentPage === totalPages">
              <button class="page-link" (click)="nextPage()" aria-label="Next">
                <span aria-hidden="true">Next &raquo;</span>
              </button>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>

  <!-- Digital Cash Memo Modal -->
  <div class="modal fade"
    tabindex="-1"
    [class.show]="isReportModalOpen"
    [style.display]="isReportModalOpen ? 'block' : 'none'"
    [attr.aria-hidden]="!isReportModalOpen"
    aria-labelledby="cashMemoModalLabel"
    (click)="closeReportModal()">
    <div class="modal-dialog modal-xl modal-dialog-scrollable cash-memo-modal" (click)="$event.stopPropagation()">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header">
          <div>
            <h5 class="modal-title fw-semibold" id="cashMemoModalLabel">Digital Cash Memo</h5>
            <small class="text-muted">Invoice snapshot for the selected order</small>
          </div>
          <button type="button" class="btn-close" aria-label="Close" (click)="closeReportModal()"></button>
        </div>

        <div class="modal-body cash-memo-modal-body">
          <ng-container *ngIf="reportData as report; else noReportSelected">
            <div class="cash-memo-print-area" id="cashMemoPrintable">
              <article class="cash-memo-sheet">
                <header class="cash-memo-header">
                  <div>
                    <p class="cash-memo-brand mb-1">Cartify</p>
                    <h4 class="mb-1">Digital Cash Memo</h4>
                    <small class="text-muted">Professional order invoice report</small>
                  </div>
                  <div class="text-end">
                    <div class="memo-status-chip"
                      [ngClass]="{
                        'status-delivered': report.order.status === 'Delivered',
                        'status-pending': report.order.status === 'Pending',
                        'status-shipped': report.order.status === 'Shipped',
                        'status-cancelled': report.order.status === 'Cancelled'
                      }">
                      {{ report.order.status }}
                    </div>
                    <p class="mb-0 mt-2 small text-muted">Order ID: <span class="fw-semibold text-dark">#{{ report.order.id }}</span></p>
                    <p class="mb-0 small text-muted">Order Date: <span class="fw-semibold text-dark">{{ report.order.date }}</span></p>
                  </div>
                </header>

                <section class="cash-memo-grid">
                  <div class="cash-memo-block">
                    <h6>Customer & Contact</h6>
                    <p><span>Customer:</span> {{ report.customerName }}</p>
                    <p><span>Email:</span> {{ report.email }}</p>
                    <p><span>Phone:</span> {{ report.phone }}</p>
                  </div>
                  <div class="cash-memo-block">
                    <h6>Addresses</h6>
                    <p><span>Shipping:</span> {{ report.shippingAddress }}</p>
                    <p><span>Billing:</span> {{ report.billingAddress }}</p>
                  </div>
                </section>

                <section class="cash-memo-section">
                  <h6 class="cash-memo-section-title">Order Details</h6>
                  <div class="table-responsive">
                    <table class="table table-sm align-middle memo-items-table mb-0">
                      <thead>
                        <tr>
                          <th scope="col">Product</th>
                          <th scope="col" class="text-center">Quantity</th>
                          <th scope="col" class="text-end">Unit Price</th>
                          <th scope="col" class="text-end">Row Total</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let item of report.items">
                          <td>{{ item.productName }}</td>
                          <td class="text-center">{{ item.quantity }}</td>
                          <td class="text-end">${{ item.unitPrice | number:'1.2-2' }}</td>
                          <td class="text-end fw-semibold">${{ item.rowTotal | number:'1.2-2' }}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </section>

                <section class="cash-memo-totals">
                  <h6 class="cash-memo-section-title">Payment & Totals</h6>
                  <div class="memo-total-row">
                    <span>Subtotal</span>
                    <span>${{ report.subtotal | number:'1.2-2' }}</span>
                  </div>
                  <div class="memo-total-row">
                    <span>Discount</span>
                    <span>- ${{ report.discount | number:'1.2-2' }}</span>
                  </div>
                  <div class="memo-total-row">
                    <span>Shipping</span>
                    <span>${{ report.shipping | number:'1.2-2' }}</span>
                  </div>
                  <div class="memo-total-row">
                    <span>Tax</span>
                    <span>${{ report.tax | number:'1.2-2' }}</span>
                  </div>
                  <div class="memo-total-row grand-total">
                    <span>Final Total</span>
                    <span>${{ report.finalTotal | number:'1.2-2' }}</span>
                  </div>
                </section>

                <section class="cash-memo-grid metadata-grid">
                  <div class="cash-memo-block">
                    <h6>Metadata</h6>
                    <p><span>Market:</span> {{ report.market }}</p>
                    <p><span>Tags:</span> {{ report.tags }}</p>
                    <p><span>Payment Terms:</span> {{ report.paymentTerms }}</p>
                  </div>
                  <div class="cash-memo-block">
                    <h6>Notes</h6>
                    <p class="memo-notes">{{ report.notes }}</p>
                  </div>
                </section>
              </article>
            </div>
          </ng-container>
          <ng-template #noReportSelected>
            <div class="alert alert-light border text-muted mb-0">
              Select exactly one order and click Report to generate the cash memo.
            </div>
          </ng-template>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" (click)="closeReportModal()">Close</button>
          <button type="button"
            class="btn btn-outline-primary"
            [disabled]="selectedOrderIds.size !== 1"
            (click)="printOrder()">
            <i class="bi bi-printer me-1"></i> Print
          </button>
          <button type="button"
            class="btn btn-success"
            [disabled]="selectedOrderIds.size !== 1 || isReportDownloading"
            (click)="downloadOrder()">
            <span *ngIf="isReportDownloading" class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
            <i *ngIf="!isReportDownloading" class="bi bi-download me-1"></i>
            {{ isReportDownloading ? 'Generating PDF...' : 'Download PDF' }}
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-backdrop fade show" *ngIf="isAddOrderModalOpen"></div>
</div>
