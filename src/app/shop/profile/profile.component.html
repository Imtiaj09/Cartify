<div class="container py-5">
  <div class="row mb-4">
    <div class="col-12">
      <h2 class="fw-bold">My Account</h2>
      <p class="text-muted">Manage your orders and personal details</p>
    </div>
  </div>

  <div class="row">
    <!-- Left Sidebar -->
    <div class="col-lg-3 mb-4 mb-lg-0">
      <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
        <div class="list-group list-group-flush">
          <button type="button"
                  class="list-group-item list-group-item-action py-3 px-4 border-0 d-flex align-items-center"
                  [class.active]="activeTab === 'orders'"
                  (click)="changeTab('orders')">
            <i class="bi bi-box-seam me-3 fs-5"></i>
            My Orders
          </button>
          <button type="button"
                  class="list-group-item list-group-item-action py-3 px-4 border-0 d-flex align-items-center"
                  [class.active]="activeTab === 'details'"
                  (click)="changeTab('details')">
            <i class="bi bi-person me-3 fs-5"></i>
            Account Details
          </button>
          <button type="button"
                  class="list-group-item list-group-item-action py-3 px-4 border-0 d-flex align-items-center"
                  [class.active]="activeTab === 'password'"
                  (click)="changeTab('password')">
            <i class="bi bi-lock me-3 fs-5"></i>
            Change Password
          </button>
          <button type="button"
                  class="list-group-item list-group-item-action py-3 px-4 border-0 d-flex align-items-center text-danger"
                  (click)="logout()">
            <i class="bi bi-box-arrow-right me-3 fs-5"></i>
            Logout
          </button>
        </div>
      </div>
    </div>

    <!-- Right Content Area -->
    <div class="col-lg-9">
      <div class="card border-0 shadow-sm rounded-4 p-4 min-vh-50">

        <!-- Orders Tab -->
        <div *ngIf="activeTab === 'orders'">
          <h4 class="fw-bold mb-4">Order History</h4>

          <div *ngIf="orders.length === 0" class="text-center py-5">
            <i class="bi bi-cart-x display-1 text-muted mb-3"></i>
            <p class="lead text-muted">No orders found yet.</p>
            <a routerLink="/shop/products" class="btn btn-success mt-2">Start Shopping</a>
          </div>

          <div class="d-flex flex-column gap-3">
            <div *ngFor="let order of orders" class="card border rounded-3 p-3 hover-shadow transition-all">
              <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">

                <div class="d-flex flex-column">
                  <span class="fw-bold text-dark fs-5">{{ order.id }}</span>
                  <span class="text-muted small">{{ order.date | date:'mediumDate' }}</span>
                </div>

                <div class="d-flex flex-column">
                  <span class="text-muted small">Total</span>
                  <span class="fw-bold text-success">{{ order.total | currency:'BDT':'symbol':'1.2-2' }}</span>
                </div>

                <div class="d-flex flex-column">
                  <span class="text-muted small">Items</span>
                  <span class="fw-semibold">{{ getOrderItemCount(order) }} items</span>
                </div>

                <div class="d-flex flex-column">
                  <span class="text-muted small">Status</span>
                  <span class="badge rounded-pill" [ngClass]="getStatusClass(order.status)">
                    {{ order.status }}
                  </span>
                </div>

                <div>
                  <button class="btn btn-outline-secondary btn-sm rounded-pill px-3" type="button" (click)="openInvoice(order)">
                    View Details
                  </button>
                </div>

              </div>
            </div>
          </div>
        </div>

        <!-- Account Details Tab -->
        <div *ngIf="activeTab === 'details'">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="fw-bold mb-0">Profile Information</h4>
            <button class="btn btn-outline-primary btn-sm rounded-pill px-3" (click)="toggleEdit()">
              <i class="bi" [ngClass]="isEditing ? 'bi-x-lg' : 'bi-pencil-square'"></i>
              {{ isEditing ? 'Cancel' : 'Edit Profile' }}
            </button>
          </div>

          <div *ngIf="successMessage" class="alert alert-success">{{ successMessage }}</div>
          <div *ngIf="errorMessage" class="alert alert-danger">{{ errorMessage }}</div>

          <ng-container *ngIf="currentUser$ | async as user">
            <div class="row g-4">
              <div class="col-12 d-flex align-items-center gap-3 mb-2">
                <div class="avatar-upload-wrapper" [class.avatar-upload-wrapper-editing]="isEditing">
                  <img
                    [src]="(isEditing ? (editAvatarUrl || user.avatarUrl) : user.avatarUrl) || defaultAvatarUrl"
                    alt="Profile"
                    class="profile-avatar rounded-circle"
                  >
                  <input
                    type="file"
                    #fileInput
                    class="d-none"
                    (change)="onFileSelected($event)"
                    accept="image/*"
                  >
                  <button
                    *ngIf="isEditing"
                    type="button"
                    class="avatar-overlay border-0"
                    (click)="fileInput.click()"
                    aria-label="Upload avatar"
                  >
                    <i class="bi bi-camera"></i>
                  </button>
                </div>
                <div>
                  <h5 class="fw-bold mb-1">{{ user.firstName }} {{ user.lastName }}</h5>
                  <p class="text-muted mb-0">{{ user.email }}</p>
                </div>
              </div>

              <ng-container *ngIf="!isEditing; else editFields">
                <div class="col-md-6">
                  <label class="form-label text-muted small text-uppercase fw-bold">First Name</label>
                  <div class="profile-info-value">{{ user.firstName }}</div>
                </div>

                <div class="col-md-6">
                  <label class="form-label text-muted small text-uppercase fw-bold">Last Name</label>
                  <div class="profile-info-value">{{ user.lastName }}</div>
                </div>

                <div class="col-md-6">
                  <label class="form-label text-muted small text-uppercase fw-bold">Email Address</label>
                  <div class="profile-info-value">{{ user.email }}</div>
                </div>

                <div class="col-md-6">
                  <label class="form-label text-muted small text-uppercase fw-bold">Phone Number</label>
                  <div class="profile-info-value">{{ user.phone || 'Not provided' }}</div>
                </div>
              </ng-container>

              <ng-template #editFields>
                <div class="col-md-6">
                  <label for="firstName" class="form-label">First Name</label>
                  <input
                    id="firstName"
                    type="text"
                    class="form-control"
                    [value]="editFirstName"
                    (input)="editFirstName = $any($event.target).value"
                  >
                </div>

                <div class="col-md-6">
                  <label for="lastName" class="form-label">Last Name</label>
                  <input
                    id="lastName"
                    type="text"
                    class="form-control"
                    [value]="editLastName"
                    (input)="editLastName = $any($event.target).value"
                  >
                </div>

                <div class="col-md-6">
                  <label class="form-label text-muted small text-uppercase fw-bold">Email Address</label>
                  <div class="profile-info-value">{{ user.email }}</div>
                </div>

                <div class="col-md-6">
                  <label class="form-label text-muted small text-uppercase fw-bold">Phone Number</label>
                  <div class="profile-info-value">{{ user.phone || 'Not provided' }}</div>
                </div>

                <div class="col-12 mt-2">
                  <button type="button" class="btn btn-success px-4 rounded-pill" [disabled]="loading" (click)="saveChanges()">
                    <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    Save Changes
                  </button>
                </div>
              </ng-template>
            </div>
          </ng-container>
        </div>

        <!-- Change Password Tab -->
        <div *ngIf="activeTab === 'password'">
          <h4 class="fw-bold mb-4">Change Password</h4>

          <div *ngIf="successMessage" class="alert alert-success">{{ successMessage }}</div>
          <div *ngIf="errorMessage" class="alert alert-danger">{{ errorMessage }}</div>

          <form [formGroup]="passwordForm" (ngSubmit)="onChangePassword()" class="row g-3" style="max-width: 500px;">
            <div class="col-12">
              <label for="currentPassword" class="form-label">Current Password</label>
              <input type="password" class="form-control" id="currentPassword" formControlName="currentPassword">
            </div>
            <div class="col-12">
              <label for="newPassword" class="form-label">New Password</label>
              <input type="password" class="form-control" id="newPassword" formControlName="newPassword">
            </div>
            <div class="col-12">
              <label for="confirmPassword" class="form-label">Confirm New Password</label>
              <input type="password" class="form-control" id="confirmPassword" formControlName="confirmPassword">
              <div *ngIf="passwordForm.errors?.mismatch && (passwordForm.touched || passwordForm.dirty)" class="text-danger small mt-1">
                Passwords do not match
              </div>
            </div>
            <div class="col-12 mt-4">
              <button type="submit" class="btn btn-success px-4 rounded-pill" [disabled]="loading || passwordForm.invalid">
                <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                Update Password
              </button>
            </div>
          </form>
        </div>

      </div>
    </div>
  </div>
</div>

<div
  id="profileInvoiceModal"
  class="modal fade profile-invoice-modal"
  tabindex="-1"
  [class.show]="isInvoiceModalOpen"
  [style.display]="isInvoiceModalOpen ? 'block' : 'none'"
  [attr.aria-hidden]="!isInvoiceModalOpen"
  (click)="closeInvoice()">
  <div class="modal-dialog modal-xl modal-dialog-scrollable" (click)="$event.stopPropagation()">
    <div class="modal-content" *ngIf="selectedOrder as order">
      <div class="modal-header no-print">
        <h5 class="modal-title">Digital Cash Memo</h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="closeInvoice()"></button>
      </div>

      <div class="modal-body profile-invoice-body">
        <article class="profile-tax-invoice">
          <header class="profile-invoice-head">
            <div>
              <p class="profile-invoice-logo mb-1">CARTIFY</p>
              <h4 class="mb-0">Tax Invoice</h4>
            </div>
            <div class="text-end">
              <p class="mb-1"><span class="profile-label">Order ID:</span> {{ order.id }}</p>
              <p class="mb-1"><span class="profile-label">Date:</span> {{ order.date | date:'medium' }}</p>
              <p class="mb-0"><span class="profile-label">Status:</span> {{ order.status }}</p>
            </div>
          </header>

          <section class="row g-3 mb-4">
            <div class="col-md-6">
              <div class="profile-invoice-block h-100">
                <h6>Billing Details</h6>
                <p class="mb-1 fw-semibold">{{ order.customerDetails.name }}</p>
                <p class="mb-1">{{ order.customerDetails.email || 'No email provided' }}</p>
                <p class="mb-0">{{ order.customerDetails.address || order.shippingDetails.address || 'No address provided' }}</p>
              </div>
            </div>
            <div class="col-md-6">
              <div class="profile-invoice-block h-100">
                <h6>Shipping Address</h6>
                <p class="mb-1">{{ order.shippingDetails.address || order.customerDetails.address || 'No shipping address provided' }}</p>
                <p class="mb-0" *ngIf="order.shippingDetails.city || order.shippingDetails.postalCode">
                  {{ order.shippingDetails.city }} {{ order.shippingDetails.postalCode }}
                </p>
              </div>
            </div>
          </section>

          <section class="mb-4">
            <div class="table-responsive">
              <table class="table table-sm profile-invoice-items mb-0">
                <thead>
                  <tr>
                    <th>Item</th>
                    <th class="text-center">Qty</th>
                    <th class="text-end">Price</th>
                    <th class="text-end">Line Total</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of order.items; let itemIndex = index">
                    <td>{{ item.product.name }}</td>
                    <td class="text-center">{{ item.quantity }}</td>
                    <td class="text-end">
                      {{ (item.product.discountedPrice !== null ? item.product.discountedPrice : item.product.price) | currency:'BDT':'symbol':'1.2-2' }}
                    </td>
                    <td class="text-end fw-semibold">
                      {{ getOrderLineTotal(order, itemIndex) | currency:'BDT':'symbol':'1.2-2' }}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <section class="profile-invoice-totals ms-auto">
            <div class="profile-total-row">
              <span>Subtotal</span>
              <span>{{ order.subtotal | currency:'BDT':'symbol':'1.2-2' }}</span>
            </div>
            <div class="profile-total-row">
              <span>Shipping Fee</span>
              <span>{{ order.shippingFee | currency:'BDT':'symbol':'1.2-2' }}</span>
            </div>
            <div class="profile-total-row grand-total">
              <span>Grand Total</span>
              <span>{{ order.total | currency:'BDT':'symbol':'1.2-2' }}</span>
            </div>
          </section>
        </article>
      </div>

      <div class="modal-footer no-print">
        <button type="button" class="btn btn-outline-secondary" (click)="closeInvoice()">Close</button>
        <button type="button" class="btn btn-success" (click)="printInvoice()">
          <i class="bi bi-printer me-1"></i>
          Print
        </button>
      </div>
    </div>
  </div>
</div>

<div *ngIf="isInvoiceModalOpen" class="modal-backdrop fade show"></div>
